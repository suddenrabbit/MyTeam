@{
    ViewBag.Title = "需求出池";
}

<h2>@ViewBag.Title</h2>
<script language="javascript" type="text/javascript" src="~/Scripts/My97DatePicker/WdatePicker.js"></script>
<script>
    function getReqs() {
        var sysID = $('#SysID').val();
        $.ajax({
            type: 'GET',
            url: '/ReqManage/GetReqsToOutPool?sysID=' + sysID,
            success: function (msg) {
                $('#ReqsDiv').html(msg);
            },
            error: function () {
                alert("出错了，请联系管理员");
            }

        });
    }
    // 2016年8月10日新增：同时更新版本号下拉框
    function getVers() {
        var sysID = $('#SysID').val();
        $.ajax({
            type: 'GET',
            url: '/ReqManage/GetVersToOutPool?sysID=' + sysID,
            success: function (msg) {
                $('#Ver1').html(msg);
            },
            error: function () {
                alert("出错了，请联系管理员");
            }

        });
    }

    function quickOutPool() {
        var sysID = $('#SysID').val();
        var reqs = $('#Reqs').val();       
        var outDate = $('#OutDate').val();
        var planReleaseDate = $('#PlanReleaseDate').val();
        var isPatch = $('#isPatch').prop('checked');

        var version;
        if (isPatch) {
            version = $('#Ver2').val();
        } else {
            version = $('#Ver1').val();
        }

        if (sysID == 0) {
            alert("请选择系统！");
            return;
        }
        if (reqs == null || reqs.length < 1) {
            alert("请选择要出池的需求！");
            return;
        }
        if (version.length < 1) {
            alert("版本号不能为空！");
            $('#Version').focus();
            return;
        }
        if (outDate.length < 1) {
            alert("出池日期不能为空！");
            $('#OutDate').focus();
            return;
        }
        if (planReleaseDate.length < 1) {
            alert("计划下发日期不能为空！");
            $('#PlanReleaseDate').focus();
            return;
        }
        $.ajax({
            type: 'POST',
            url: '/ReqManage/OutPool',
            data: 'Reqs=' + reqs + "&Version=" + version + "&OutDate=" + outDate + "&PlanReleaseDate=" + planReleaseDate + "&SysID=" + sysID + "&IsPatch=" + isPatch,
            success: function (msg) {
                $('#OutPoolResult').html(msg);
                $('#ReleaseNoDiv').show();
                $('#OutPoolBtn').hide();
            },
            error: function () {
                alert("出错了，请联系管理员");
                $('#ReleaseNoDiv').hide();
            }

        });

    }

    function updateReleaseNo() {
        var reqs = $('#Reqs').val();
        var releaseNo = $('#ReleaseNo').val();
        var sideReleaseNo = $('#SideReleaseNo').val();
        var planReleaseDate = $('#PlanReleaseDate').val();

        if (reqs == null || reqs.length < 1) {
            alert("请选择要出池的需求！");
            return;
        }

        // 下发通知编号格式控制
        var rname = /(YFZX){1}[0-9]{8}/;
        if (releaseNo.length > 0 && !rname.test(releaseNo)) {
                alert("下发通知编号格式必须是YFZX+8位数字");
                $("#ReleaseNo").focus();
                return;
                      
        }

        // 副下发通知编号格式控制
        if (sideReleaseNo.length > 0) {
            if (!rname.test(sideReleaseNo)) {
                alert("副下发通知编号格式必须是YFZX+8位数字");
                $("#SideReleaseNo").focus();
                return;
            }
           
            if (releaseNo.length == 0) {
                alert("不能只填副下发编号");
                $("#ReleaseNo").focus();
                return;
            }
        }

        $.ajax({
            type: 'POST',
            url: '/ReqManage/UpdateReleaseNo',
            data: 'Reqs=' + reqs + "&ReleaseNo=" + releaseNo + "&SideReleaseNo=" + sideReleaseNo + "&PlanReleaseDate=" + planReleaseDate,
            success: function (msg) {
                $('#OutPoolResult').hide();
                $('#ReleaseNoResultDiv').html(msg);                
            },
            error: function () {
                alert("出错了，请联系管理员");
            }

        });
    }

    // 2016年8月10日新增：勾选补丁版本则变成输入框
    function changeVerType() {
        var d1 = $('#Ver1');
        var d2 = $('#Ver2');
        
        if ($('#isPatch').prop('checked')) {
            d1.hide();
            d2.show();            
        } else {
            d1.show();
            d2.hide();            
        }
    }

</script>
<div class="row card">
    <div class="col-md-10 form-horizontal">
        <div class="form-group">
            <label class="col-md-2 control-label">选择需求</label>
            <div class="col-md-5">
                <!--系统下拉选择-->
                @Html.DropDownList("SysID", ViewBag.SysList as SelectList, new { @class = "form-control", @onchange = "getReqs();getVers()" })
            </div>
            <div class="col-md-5">
                <div id="ReqsDiv">
                    <select id="Reqs" name="Reqs" multiple="multiple" class="form-control" size="1">
                        <option>--请选择系统--</option>
                    </select>
                </div>

                <span class="text-info">（按住Ctrl键多选）</span>
            </div>
        </div>

        <!-- 版本号部分：选择系统后默认提供今年的版本号下拉框，如勾选「补丁版本」则变成输入框-->
        <div class="form-group">
            <label for="Version" class="col-md-2 control-label">版本号</label>
            <div class="col-md-10">
                <select id="Ver1" class="form-control">
                    <option>--请选择系统--</option>
                </select>
                <input id="Ver2" type="text" class="form-control" style="display:none" />

                <div style="margin-top:10px;margin-bottom:10px"><input type="checkbox" id="isPatch" onclick="changeVerType()"/>&nbsp;补丁版本</div>

            </div>
            <div class="form-group">
                <label for="OutDate" class="col-md-2 control-label">出池日期</label>
                <div class="col-md-10">
                    <input id="OutDate" type="text" class="form-control Wdate datepicker" onclick="WdatePicker({ dateFmt: 'yyyy/M/d' })" placeholder="点击选择日期" />
                </div>
            </div>
            <div class="form-group">
                <label for="PlanReleaseDate" class="col-md-2 control-label">计划下发日期</label>
                <div class="col-md-10">
                    <input id="PlanReleaseDate" type="text" class="form-control Wdate datepicker" onclick="WdatePicker({ dateFmt: 'yyyy/M/d' })" placeholder="点击选择日期" />
                </div>
            </div>

            <div class="form-group">
                <div class="col-md-offset-2 col-md-10">
                    <input type="button" value="出池" class="btn btn-primary" onclick="quickOutPool()" id="OutPoolBtn"/>
                </div>
            </div>

            <div id="OutPoolResult"></div>


            <!--默认隐藏：出池成功后显示，用以更新下发通知编号-->
            <div id="ReleaseNoDiv" style="display:none">
                <div class="form-group">
                    <label for="ReleaseNo" class="col-md-2 control-label">主下发通知编号</label>
                    <div class="col-md-10">
                        <input id="ReleaseNo" type="text" class="form-control" maxlength="12" />
                    </div>
                </div>
                <div class="form-group">
                    <label for="SideReleaseNo" class="col-md-2 control-label">副下发通知编号</label>
                    <div class="col-md-10">
                        <input id="SideReleaseNo" type="text" class="form-control" maxlength="12" />
                    </div>
                </div>
                <div class="form-group">
                    <div class="col-md-offset-2 col-md-10">
                        <input type="button" value="更新下发通知编号" class="btn btn-primary" onclick="updateReleaseNo()" />
                    </div>
                </div>

                <div id="ReleaseNoResultDiv"></div>
            </div>
        </div>
    </div>
</div>

<script>
    $("#SysID").select2();
    $("#ReleaseNo").val('YFZX'+'@DateTime.Now.Year');
</script>