@model MyTeam.Models.RegReq
@{
    ViewBag.Title = "需求登记";
}
<h2>@ViewBag.Title</h2>
<script language="javascript" type="text/javascript" src="~/Scripts/My97DatePicker/WdatePicker.js"></script>

@using (Html.BeginForm("RegResult", "ReqManage", new { ReturnUrl = ViewBag.ReturnUrl }, FormMethod.Post,
                                           new { @class = "form-horizontal", role = "form", onsubmit = "return checkName()" }))
{
    <div class="row card">
        @Html.AntiForgeryToken()

        <table class="table table-condensed query-table">
            <tr>
                <td> <!--系统下拉选择-->@Html.LabelFor(model => model.SysID, new { @class = "control-label" })</td>
                <td>@Html.DropDownListFor(model => model.SysID, ViewBag.SysList as SelectList, new { @class = "form-control" })</td>
                <td>@Html.LabelFor(model => model.AcptDate, new { @class = "control-label" })</td>
                <td>
                    @Html.EditorFor(model => model.AcptDate, "DateTime")
                    @Html.ValidationMessageFor(model => model.AcptDate, "", new { @class = "text-danger" })
                </td>
            </tr>

            <tr>
                <td>@Html.LabelFor(model => model.ReqNo, new { @class = "control-label" })</td>
                <td>
                    @Html.TextBoxFor(model => model.ReqNo, new { @class = "form-control" })
                    @Html.ValidationMessageFor(model => model.ReqNo, "", new { @class = "text-danger" })
                    <input type="checkbox" onclick="noReqNo()" /><span class="text-info">暂无（将以当前时间戳代替）</span>
                </td>
                <td>@Html.LabelFor(model => model.ReqReason, new { @class = "control-label" })</td>

                <td>
                    @Html.TextBoxFor(model => model.ReqReason, new { @class = "form-control" })
                    @Html.ValidationMessageFor(model => model.ReqReason, "", new { @class = "text-danger" })
                </td>
            </tr>

            <!--需求发起单位下拉选择-->
            <tr>
                <td>@Html.LabelFor(model => model.ReqFromDept, new { @class = "control-label" })</td>
                <td>
                    @Html.DropDownListFor(model => model.ReqFromDept, ViewBag.ReqFromDeptList as SelectList, new { @class = "form-control" })
                </td>

                <td>
                    @Html.LabelFor(model => model.ReqFromPerson, new { @class = "control-label" })
                </td>
                <td>
                    @Html.TextBoxFor(model => model.ReqFromPerson, new { @class = "form-control" })
                    @Html.ValidationMessageFor(model => model.ReqFromPerson, "", new { @class = "text-danger" })
                </td>
            </tr>

            <tr>
                <td><!--需求受理人下拉选择-->@Html.LabelFor(model => model.ReqAcptPerson, new { @class = "control-label" })</td>
                <td>
                    @Html.DropDownListFor(model => model.ReqAcptPerson, ViewBag.UserList as SelectList, new { @class = "form-control" })
                </td>

                <td>
                    @Html.LabelFor(model => model.ReqBusiTestPerson, new { @class = "control-label" })
                </td>
                <td>
                    @Html.TextBoxFor(model => model.ReqBusiTestPerson, new { @class = "form-control", @placeholder = "点击自动填写需求发起人", @onclick = "$('#ReqBusiTestPerson').val($('#ReqFromPerson').val())" })
                    @Html.ValidationMessageFor(model => model.ReqBusiTestPerson, "", new { @class = "text-danger" })
                </td>
            </tr>

            
        </table>
        <hr />
   <!-- detail part: generated by reqNum -->
        <table class="table table-condensed query-table" id="detailTable">
            <tr>
                <th></th>
                <th>
                   需求概述
                </th> 
            </tr>

            <tr>
                <td><a href="###" onclick="addReqDesc()" class="text-success"><span class="glyphicon glyphicon-plus"></span></a></td>
                <td>
                    <input id="ReqDescs1" name="ReqDescs" class = "form-control" style = "margin:0 auto; max-width:100%!important" required = "required" type="text"/>
                </td> 
            </tr>
            
        </table>

        <input type="submit" value="提交" class="btn btn-primary" />
    </div>
}

<script src="~/Scripts/jquery.unobtrusive-ajax.js"></script>
<script src="~/Scripts/jquery.validate.min.js"></script>
<script src="~/Scripts/jquery.validate.unobtrusive.min.js"></script>
<script>
    // 选中 受理人、系统列表下拉加入搜索
    $(function () {
        $("#ReqAcptPerson").val('@Model.ReqAcptPerson');
        $("#SysID").select2();
    });

    // 检查业务发起人、业务测试人的格式
    function checkName() {
        var ts = /^[\u4e00-\u9fa5]{2,3}\/\d{6}$/;
        if (!ts.test($('#ReqFromPerson').val())) {
            showAlertWithDefaultTitle("需求发起人请按照「姓名（2或3个汉字）/电话（6位数字）」格式填写");
            $('#ReqFromPerson').focus();
            return false;
        }

        if (!ts.test($('#ReqBusiTestPerson').val())) {
            showAlertWithDefaultTitle("业务测试人请按照「姓名（2或3个汉字）/电话（6位数字）」格式填写");
            $('#ReqBusiTestPerson').focus();
            return false;
        }

        return true;
    }

    // 根据reqNum改变显示的detail部分
    var reqNum = 1;
    function addReqDesc() {
        reqNum++;

        var s = "<tr id='tr" + reqNum + "'><td><a href='###' onclick='delReqDesc(" + reqNum + ")' class='text-danger'><span class='glyphicon glyphicon-minus'></span></a></td><td><input name='ReqDescs' id='ReqDescs"+reqNum+"' class='form-control' style='margin:0 auto; max-width:100%!important' required='required' type='text'/></td></tr>";

        $('#detailTable').append(s); 
        
    }

    function delReqDesc(id) {
        $('#tr' + id).remove();
        reqNum--;
    }

    // 没有申请编号时，以当前时间戳代替
    function noReqNo() {
        $('#ReqNo').val('@DateTime.Now.ToString("yyyyMMddHHmmss")')
    }

</script>